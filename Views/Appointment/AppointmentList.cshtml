@using System.Data

@{
	ViewBag.Title = "Appointment List";
}

<form>
	<!-- 🔹 Search Bar -->
	<div class="row mb-3">
		<div class="col-md-2">
			<input type="number" name="AppointmentID" class="form-control" placeholder="Appointment ID" />
		</div>
		<div class="col-md-2">
			<input type="number" name="DoctorID" class="form-control" placeholder="Doctor ID" />
		</div>
		<div class="col-md-2">
			<input type="number" name="PatientID" class="form-control" placeholder="Patient ID" />
		</div>
		<div class="col-md-2">
			<select name="AppointmentStatus" class="form-control">
				<option value="">--Status--</option>
				<option value="Pending">Pending</option>
				<option value="Completed">Completed</option>
				<option value="Cancelled">Cancelled</option>
			</select>
		</div>
		<div class="col-md-2">
			<input type="date" name="FromDate" class="form-control" placeholder="From Date" />
		</div>
		<div class="col-md-2">
			<input type="date" name="ToDate" class="form-control" placeholder="To Date" />
		</div>
	</div>
	<div class="mb-3 text-end">
		<button type="submit" class="btn btn-primary">
			<i class="bi bi-search"></i> Search
		</button>
		<a asp-action="AppointmentList" class="btn btn-secondary">
			<i class="bi bi-arrow-repeat"></i> Reset
		</a>
	</div>
	<!-- 🔹 End Search Bar -->
</form>

<form asp-action="DeleteSelectedAppointments" asp-controller="Appointment" method="post">
	@Html.AntiForgeryToken()
<div class="card">
	<div class="card-body">
		<h5 class="card-title">Appointment List</h5>
		<p>Displays organized records in a clear format, allowing users to view essential details at a glance. Helps in tracking, reviewing, and managing information efficiently across various sections.</p>

			

		<div style="text-align: right; margin-bottom: 15px;">
			<a class="btn btn-primary" asp-controller="Appointment" asp-action="AppointmentEdit">
				<i class="fa fa-plus"></i> Add New
			</a>
			<a asp-action="ExportToExcel" class="btn btn-success">
				<i class="bi bi-file-earmark-excel"></i> Export to Excel
			</a>
				<button type="submit" class="btn btn-danger">
					<i class="bi ri-delete-bin-2-fill"></i> Delete Selected
				</button>
		</div>
		<div class="table-responsive" style="max-height: 400px; overflow: auto;">
			<table class="table  table-striped mb-0">
				<thead>
					<tr>
						<th><input type="checkbox" id="selectAll" /></th>

						<th>AppointmentID</th>
						@* <th>DoctorID</th>
						<th>PatientID</th> *@
						<th>AppointmentDate</th>
						<th>AppointmentStatus</th>
						<th>Description</th>
						<th>SpecialRemarks</th>
						@* <th>Created</th>
						<th>Modified</th>
						<th>UserID</th> *@
						<th>TotalConsultedAmount</th>
						<th>Action</th>

					</tr>
				</thead>
				<tbody>
					@foreach (DataRow dataRow in Model.Rows)
					{
						<tr>
								<td>
									<input type="checkbox" name="selectedUserIds" value="@dataRow["AppointmentID"]" class="appointmentCheckbox" />
								</td>
							<td>@dataRow["AppointmentID"]</td>
							@* <td>@dataRow["DoctorID"]</td>
							<td>@dataRow["PatientID"]</td> *@
								<td>@(((DateTime)dataRow["AppointmentDate"]).ToString("dd/MM/yyyy"))</td>

							<td>
								@{
									string appointmentStatus = dataRow["AppointmentStatus"].ToString();
									bool isCompleted = appointmentStatus.Equals("Completed", StringComparison.OrdinalIgnoreCase);
									string statusText = isCompleted ? "Completed" : "Pending";
									string badgeClass = isCompleted ? "status-badge active" : "status-badge not-active";
								}
								<span class="@badgeClass">@statusText</span>
							</td>
							<td>@dataRow["Description"]</td>
							<td>@dataRow["SpecialRemarks"]</td>
							@* <td>@dataRow["Created"]</td>
							<td>@dataRow["Modified"]</td>
							<td>@dataRow["UserID"]</td> *@
							<td>@dataRow["TotalConsultedAmount"]</td>
							<td>
								<div class="d-inline-flex gap-1">
									<a 
										asp-controller="Appointment" 
										asp-action="AppointmentEdit" 
										asp-route-AppointmentID="@dataRow["AppointmentID"]"
									   class="btn btn-sm btn-primary me-1"
									   title="Edit">
										<i class="bi bi-pencil-square"></i>

									</a>

									<a href="javascript:void(0);"
									   class="btn btn-sm btn-danger delete-btn d-flex align-items-center justify-content-center"
									   data-appointmentid="@dataRow["AppointmentID"]"
									   title="Delete"
										style="width:32px; height:32px; padding:0;">
										<span class="d-inline-block bg-white rounded-circle d-flex align-items-center justify-content-center"
											  style="width:18px; height:18px;">
											<i class="bi bi-x text-danger" style="font-size:12px;"></i>
										</span>
									</a>
									</div>
							</td>
						</tr>
					}
				</tbody>
			</table>
		</div>

	</div>
</div>
</form>
@section Scripts {
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

	<script>
		  document.getElementById("selectAll").addEventListener("change", function () {
			const checkboxes = document.querySelectorAll(".appointmentCheckbox");
			checkboxes.forEach(cb => cb.checked = this.checked);
		});

		document.addEventListener('DOMContentLoaded', function () {
			const deleteButtons = document.querySelectorAll('.delete-btn');

			deleteButtons.forEach(btn => {
				btn.addEventListener('click', function () {
					const appointmentId = this.getAttribute('data-appointmentid');

					Swal.fire({
						title: 'Are you sure?',
						text: 'You won\'t be able to revert this!',
						icon: 'warning',
						showCancelButton: true,
						confirmButtonColor: '#3085d6',
						cancelButtonColor: '#d33',
						confirmButtonText: 'Yes, delete it!',
						cancelButtonText: 'No'
					}).then((result) => {
						if (result.isConfirmed) {
							// Redirect to delete action
							window.location.href = '/Appointment/DeleteAppointment?AppointmentID=' + appointmentId;
						}
					});
				});
			});

			 @if (TempData["SuccessMessage"] != null)
			{
						<text>
							Swal.fire({
								icon: 'success',
								title: 'Success!',
								text: '@TempData["SuccessMessage"]',
								timer: 2000,
								showConfirmButton: false
							});
						</text>
			}
			 @if (TempData["UpdateSuccessMessage"] != null)
			{
							<text>
								Swal.fire({
									icon: 'success',
									title: 'Success!',
									text: '@TempData["UpdateSuccessMessage"]',
									timer: 2000,
									showConfirmButton: false
								});
							</text>
			}

			@* Success popup after delete *@
			@if (TempData["DeleteSuccessMessage"] != null)
			{
						<text>
							Swal.fire({
								icon: 'success',
								title: 'Deleted!',
								text: '@TempData["DeleteSuccessMessage"]',
								showConfirmButton: false,
								timer: 2000
							});
						</text>
			}
		});
			document.addEventListener('DOMContentLoaded', function () {
			const deleteButtons = document.querySelectorAll('.delete-btn');

			deleteButtons.forEach(btn => {
				btn.addEventListener('click', function () {
					const appointmentId = this.getAttribute('data-appointmentid');

					Swal.fire({
						title: 'Are you sure?',
						text: 'Do you really want to delete this user?',
						icon: 'warning',
						showCancelButton: true,
						confirmButtonColor: '#d33',
						cancelButtonColor: '#3085d6',
						confirmButtonText: 'Yes, delete it!',
						cancelButtonText: 'Cancel'
					}).then((result) => {
						if (result.isConfirmed) {
							// Now make the delete request
							$.ajax({
								url: '/Appointment/DeleteAppointment',
								type: 'POST',
								data: { AppointmentID: appointmentId },
								success: function () {
									Swal.fire({
										icon: 'success',
										title: 'Deleted!',
										text: 'User deleted successfully.',
										timer: 2000,
										showConfirmButton: false
									}).then(() => {
										location.reload(); // Reload the page
									});
								},
								error: function () {
									Swal.fire({
										icon: 'error',
										title: 'Error!',
										text: 'There was a problem deleting the user.'
									});
								}
							});
						}
					});
				});
			});

			// Optional: Display success message from TempData (after redirect)
			@if (TempData["DeleteSuccessMessage"] != null)
			{
						<text>
							Swal.fire({
								icon: 'success',
								title: 'Deleted!',
								text: '@TempData["DeleteSuccessMessage"]',
								timer: 2000,
								showConfirmButton: false
							});
						</text>
			}
		});
	</script>
}
<style>
	.status-badge {
		display: inline-block;
		padding: 4px 12px;
		border-radius: 50px;
		font-size: 0.875rem;
		font-weight: 500;
		text-align: center;
		border: 1px solid;
		pointer-events: none;
	}

		.status-badge.active {
			color: #198754; /* Bootstrap green */
			background-color: rgba(25, 135, 84, 0.15); /* transparent green */
			border-color: #198754;
		}

		.status-badge.not-active {
			color: #dc3545; /* Bootstrap red */
			background-color: rgba(220, 53, 69, 0.15); /* transparent red */
			border-color: #dc3545;
		}
</style>
