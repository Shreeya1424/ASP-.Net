@using System.Data

@{
	ViewBag.Title = "Department List";
}
<form asp-action="DeleteSelectedDepartments" asp-controller="Department" method="post">
    @Html.AntiForgeryToken()
<div class="card">
	<div class="card-body">
		<h5 class="card-title">Department List</h5>
		<p>Displays organized records in a clear format, allowing users to view essential details at a glance. Helps in tracking, reviewing, and managing information efficiently across various sections.</p>
	
		<div style="text-align: right; margin-bottom: 15px;">
			<a class="btn btn-primary" asp-controller="Department" asp-action="DepartmentAddEdit">
				<i class="bi bi-person-plus me-1"></i> Add New
			</a>
			<a asp-action="ExportToExcel" class="btn btn-success">
				<i class="bi bi-file-earmark-excel"></i> Export to Excel
			</a>
				<button type="submit" class="btn btn-danger">
					<i class="bi ri-delete-bin-2-fill"></i> Delete Selected
				</button>
		</div>

		<div class="table-responsive" style="max-height: 400px; overflow: auto;">
			<table class="table  table-striped mb-0">

						<thead>
							<tr>

							<th><input type="checkbox" id="selectAll" /></th>

								<th>DepartmentID</th>
								<th>DepartmentName</th>
								<th>Description</th>
							@* <td>UserName</td> *@
							<th>IsActive</th>
								@* <th>Created</th>
								<th>Modified</th>
								<th>UserId</th> *@
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							@foreach (DataRow dataRow in Model.Rows)
							{
								<tr>
								<td>
									<input type="checkbox" name="selectedUserIds" value="@dataRow["DepartmentID"]" class="departmentCheckbox" />
								</td>
									<td>@dataRow["DepartmentID"]</td>
									<td>@dataRow["DepartmentName"]</td>
									<td>@dataRow["Description"]</td>
								    @* <td>@dataRow["UserName"]</td> *@
							<td>
								@{
									bool isActive = Convert.ToBoolean(dataRow["IsActive"]);
									string statusText = isActive ? "Active" : "Not Active";
									string badgeClass = isActive ? "status-badge active" : "status-badge not-active";
								}
								<span class="@badgeClass">@statusText</span>
							</td>									@* <td>@dataRow["Created"]</td>
									<td>@dataRow["Modified"]</td>
									<td>@dataRow["UserID"]</td> *@
							<td>
							<div class="d-inline-flex gap-1">
									<a 
										asp-controller="Department" 
										asp-action="DepartmentEdit" 
										asp-route-DepartmentID="@dataRow["DepartmentID"]"
										   class="btn btn-sm btn-primary me-1"
										   title="Edit">
											<i class="bi bi-pencil-square"></i>
									</a>

										<a href="javascript:void(0);"
										   class="btn btn-sm btn-danger delete-btn d-flex align-items-center justify-content-center"
										   data-departmentId="@dataRow["DepartmentID"]"
										   title="Delete" 
										   style="width:32px; height:32px; padding:0;">
											<span class="d-inline-block bg-white rounded-circle d-flex align-items-center justify-content-center"
												  style="width:18px; height:18px;">
												<i class="bi bi-x text-danger" style="font-size:12px;"></i>
											</span>
									</a>
									</div>
								
							</td>
								</tr>
							}

						</tbody>
					</table>
			</div>
		</div>

	</div>

</form>

@section Scripts {
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

	<script>

		document.getElementById("selectAll").addEventListener("change", function () {
			const checkboxes = document.querySelectorAll(".departmentCheckbox");
			checkboxes.forEach(cb => cb.checked = this.checked);
		});

		document.addEventListener('DOMContentLoaded', function () {
			const deleteButtons = document.querySelectorAll('.delete-btn');

			deleteButtons.forEach(btn => {
				btn.addEventListener('click', function () {
					const departmentId = this.getAttribute('data-departmentId');

					Swal.fire({
						title: 'Are you sure?',
						text: 'You won\'t be able to revert this!',
						icon: 'warning',
						showCancelButton: true,
						confirmButtonColor: '#3085d6',
						cancelButtonColor: '#d33',
						confirmButtonText: 'Yes, delete it!',
						cancelButtonText: 'No'
					}).then((result) => {
						if (result.isConfirmed) {
							// Redirect to delete action
							window.location.href = '/Department/DeleteDepartment?DepartmentID=' + departmentId;
						}
					});
				});
			});

			 @if (TempData["SuccessMessage"] != null)
			{
						<text>
							Swal.fire({
								icon: 'success',
								title: 'Success!',
								text: '@TempData["SuccessMessage"]',
								timer: 2000,
								showConfirmButton: false
							});
						</text>
			}
			@if (TempData["UpdateSuccessMessage"] != null)
			{
							<text>
								Swal.fire({
									icon: 'success',
									title: 'Success!',
									text: '@TempData["UpdateSuccessMessage"]',
									timer: 2000,
									showConfirmButton: false
								});
							</text>
			}

			@* Success popup after delete *@
			@if (TempData["DeleteSuccessMessage"] != null)
			{
						<text>
							Swal.fire({
								icon: 'success',
								title: 'Deleted!',
								text: '@TempData["DeleteSuccessMessage"]',
								showConfirmButton: false,
								timer: 2000
							});
						</text>
			}
		});
			document.addEventListener('DOMContentLoaded', function () {
			const deleteButtons = document.querySelectorAll('.delete-btn');

			deleteButtons.forEach(btn => {
				btn.addEventListener('click', function () {
					const departmentId = this.getAttribute('data-departmentId');

					Swal.fire({
						title: 'Are you sure?',
						text: 'Do you really want to delete this department?',
						icon: 'warning',
						showCancelButton: true,
						confirmButtonColor: '#d33',
						cancelButtonColor: '#3085d6',
						confirmButtonText: 'Yes, delete it!',
						cancelButtonText: 'Cancel'
					}).then((result) => {
						if (result.isConfirmed) {
							// Now make the delete request
							$.ajax({
								url: '/Department/DeleteDepartment',
								type: 'POST',
								data: { DepartmentID: departmentId },
								success: function () {
									Swal.fire({
										icon: 'success',
										title: 'Deleted!',
										text: 'User deleted successfully.',
										timer: 2000,
										showConfirmButton: false
									}).then(() => {
										location.reload(); // Reload the page
									});
								},
								error: function () {
									Swal.fire({
										icon: 'error',
										title: 'Error!',
										text: 'There was a problem deleting the user.'
									});
								}
							});
						}
					});
				});
			});

			// Optional: Display success message from TempData (after redirect)
			@if (TempData["DeleteSuccessMessage"] != null)
			{
						<text>
							Swal.fire({
								icon: 'success',
								title: 'Deleted!',
								text: '@TempData["DeleteSuccessMessage"]',
								timer: 2000,
								showConfirmButton: false
							});
						</text>
			}
		});
	</script>
}

<style>
	.status-badge {
		display: inline-block;
		padding: 4px 12px;
		border-radius: 50px;
		font-size: 0.875rem;
		font-weight: 500;
		text-align: center;
		border: 1px solid;
		pointer-events: none;
	}

		.status-badge.active {
			color: #198754; /* Bootstrap green */
			background-color: rgba(25, 135, 84, 0.15); /* transparent green */
			border-color: #198754;
		}

		.status-badge.not-active {
			color: #dc3545; /* Bootstrap red */
			background-color: rgba(220, 53, 69, 0.15); /* transparent red */
			border-color: #dc3545;
		}
</style>